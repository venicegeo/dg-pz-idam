@Library('pipelib@master') _

node {
  def mvn = tool 'M3'
  def root = pwd()

 stage('Build/Install Job Common') {
     
    git([
      url: env.GIT_URL ? env.GIT_URL : 'https://github.com/venicegeo/dg-pz-jobcommon',
      branch: "master"
    ])
    sh """
      echo ${root}
      ${mvn}/bin/mvn install -U -Dmaven.repo.local=${root}
    """
  } 

  stage('Archive') {
    git([
      url: env.GIT_URL ? env.GIT_URL : 'https://github.com/venicegeo/dg-pz-idam',
      branch: "master"
    ])
    echo "Git checkout ok"
/*    withCredentials([file(credentialsId: 'ca8591a7-fc1f-4b6d-808e-c9944c9bf4f8', variable: 'JKS')]) { */
      sh """
        echo "Starting maven clean"
        ${mvn}/bin/mvn clean package -U -Dmaven.repo.local=${root}
		echo "Maven clean ok, copying..."
/*        [ -z "\$JKS" ] || mv \$JKS ${root}/src/main/resources/pz-idam.jks */

        cp target/piazza-idam-1.0.0.jar ${root}/pz-idam.jar
		echo "Copy ok"
/*        [ -f "\$JKS" ] || rm -f \$JKS */

      """
//    }
	// Removing Maven push for coastline
	//mavenPush()
  }


  stage('Cleanup') {
    deleteDir()
  }
}
